import pytest
import nfem
import numpy as np
from numpy.testing import assert_almost_equal


@pytest.fixture
def model_1():
    model = nfem.Model()

    model.add_node(id='A', x=0, y=0, z=0, support='xyz')
    model.add_node(id='B', x=1, y=1, z=0, support='z', fy=-1)
    model.add_node(id='C', x=2, y=0, z=0, support='xyz')

    model.add_truss(id='1', node_a='A', node_b='B', youngs_modulus=1, area=1)
    model.add_truss(id='2', node_a='B', node_b='C', youngs_modulus=1, area=1)

    return model


@pytest.fixture
def model_2():
    model = nfem.Model()

    model.add_node(id='A', x=0, y=0, z=0, support='xyz')
    model.add_node(id='B', x=1, y=1, z=0, support='z')
    model.add_node(id='C', x=2, y=2, z=0, support='z', fy=-1)
    model.add_node(id='D', x=3, y=1, z=0, support='z')
    model.add_node(id='E', x=4, y=0, z=0, support='xyz')

    model.add_truss(id='1', node_a='A', node_b='B', youngs_modulus=1, area=1)
    model.add_truss(id='2', node_a='B', node_b='C', youngs_modulus=1, area=1)
    model.add_truss(id='3', node_a='C', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='4', node_a='D', node_b='E', youngs_modulus=1, area=1)
    model.add_truss(id='5', node_a='B', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='6', node_a='A', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='7', node_a='B', node_b='E', youngs_modulus=1, area=1)

    return model


@pytest.fixture
def model_3():
    model = nfem.Model()

    model.add_node(id='A', x=0, y=0, z=0, support='xyz')
    model.add_node(id='B', x=1, y=1, z=0, support='z', fy=-0.25)
    model.add_node(id='C', x=2, y=2, z=0, support='z', fy=-0.5)
    model.add_node(id='D', x=3, y=1, z=0, support='z', fy=-0.25)
    model.add_node(id='E', x=4, y=0, z=0, support='xyz')

    model.add_truss(id='1', node_a='A', node_b='B', youngs_modulus=1, area=1)
    model.add_truss(id='2', node_a='B', node_b='C', youngs_modulus=1, area=1)
    model.add_truss(id='3', node_a='C', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='4', node_a='D', node_b='E', youngs_modulus=1, area=1)
    model.add_truss(id='5', node_a='B', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='6', node_a='A', node_b='D', youngs_modulus=1, area=1)
    model.add_truss(id='7', node_a='B', node_b='E', youngs_modulus=1, area=1)

    return model


def test_1a(model_1):
    load_curve = np.linspace(0.0, 0.5, 20)

    for load_factor in load_curve:
        model_1 = model_1.get_duplicate()
        model_1.load_factor = load_factor
        model_1.perform_load_control_step(max_iterations=1000)

    actual = model_1.load_displacement_curve(('B', 'v'), skip_iterations=False)

    assert_almost_equal(actual.T[-1], [-2.4142135951481647, 0.5])


def test_1b(model_1):
    displacement_curve = np.linspace(-0.1, -2.4, 23)

    for u_hat in displacement_curve:
        model_1 = model_1.get_duplicate()
        model_1.predict_tangential(strategy='dof', dof=('B', 'v'), value=u_hat)
        model_1.perform_displacement_control_step(dof=('B', 'v'))

    actual = model_1.load_displacement_curve(('B', 'v'), skip_iterations=False)

    assert_almost_equal(actual.T, [
        [0.0, 0.0],
        [-0.09999999999999998, 0.07071067811865474],
        [-0.09999999999999998, 0.06045762979144984],
        [-0.20454545454545459, 0.11331386168514426],
        [-0.20454545454545459, 0.10328437411853902],
        [-0.3090909090909091, 0.1364856207459788],
        [-0.3090909090909091, 0.12766810278024165],
        [-0.4136363636363636, 0.14363830334316335],
        [-0.4136363636363636, 0.13603275497829462],
        [-0.5181818181818182, 0.1371958486784347],
        [-0.5181818181818182, 0.13080226991443403],
        [-0.6227272727272727, 0.119582195953529],
        [-0.6227272727272727, 0.11440058679039662],
        [-0.7272727272727272, 0.09322128437018297],
        [-0.7272727272727272, 0.08925164480791892],
        [-0.8318181818181818, 0.0605370531301331],
        [-0.8318181818181818, 0.05777938316873723],
        [-0.9363636363636363, 0.02395344143511579],
        [-0.9363636363636363, 0.022407741074588153],
        [-1.0409090909090908, -0.014105611513132426],
        [-1.0409090909090908, -0.0144393422727918],
        [-1.1454545454545455, -0.051216166512875125],
        [-1.1454545454545455, -0.05033792767166625],
        [-1.25, -0.08495428436237566],
        [-1.25, -0.08286407592029854],
        [-1.3545454545454545, -0.11289602585989764],
        [-1.3545454545454545, -0.10959384781695235],
        [-1.459090909090909, -0.13261745180370466],
        [-1.459090909090909, -0.128103304159891],
        [-1.5636363636363637, -0.14169462299206],
        [-1.5636363636363637, -0.13596850574737812],
        [-1.6681818181818182, -0.1377036002232273],
        [-1.6681818181818182, -0.1307655133776773],
        [-1.7727272727272727, -0.11822044429547021],
        [-1.7727272727272727, -0.11007038784905172],
        [-1.8772727272727272, -0.08082121600705186],
        [-1.8772727272727272, -0.07145918995976545],
        [-1.9818181818181817, -0.023081976156236368],
        [-1.9818181818181817, -0.01250798050808154],
        [-2.0863636363636364, 0.05742121445871347],
        [-2.0863636363636364, 0.06920717970773678],
        [-2.190909090909091, 0.16311229503953392],
        [-2.190909090909091, 0.1761102298894249],
        [-2.2954545454545454, 0.29641520478796074],
        [-2.2954545454545454, 0.31062510923872066],
        [-2.4, 0.4597538829057317],
        [-2.4, 0.47517575695735953],
    ])


def test_1c(model_1):
    number_of_steps = 26

    model_1 = model_1.get_duplicate()
    model_1.predict_tangential(strategy='lambda', value=0.05)
    model_1.perform_load_control_step()

    for step in range(1, number_of_steps):
        model_1 = model_1.get_duplicate()
        model_1.predict_tangential(strategy='arc-length')
        model_1.perform_arc_length_control_step()

    actual = model_1.load_displacement_curve(('B', 'v'), skip_iterations=False)

    assert_almost_equal(actual.T, [
        [0.0, 0.0],
        [-0.07071067811865472, 0.05],
        [-0.0799180181436876, 0.05],
        [-0.08007101451913168, 0.05],
        [-0.1629932758233238, 0.09511392186811382],
        [-0.165914671492015, 0.08974421059095329],
        [-0.16573287224914324, 0.0896667687689175],
        [-0.2538393786673234, 0.12355850730660084],
        [-0.25617570700920167, 0.11748488178810475],
        [-0.25595850772428896, 0.11742989748727949],
        [-0.3478836657768999, 0.1389059755773012],
        [-0.34934422671654386, 0.13265426170945907],
        [-0.349127163476182, 0.13263206206296055],
        [-0.44309787801999145, 0.1416325637449069],
        [-0.4436549845955584, 0.1358160320855562],
        [-0.4434742425041944, 0.1358204140177694],
        [-0.5378455874464767, 0.13345690749344497],
        [-0.5377217614854098, 0.12851271869413797],
        [-0.5375932587236587, 0.12852901677354145],
        [-0.6312448457741355, 0.1166574570268241],
        [-0.6307495157060038, 0.11274992945807422],
        [-0.630669076843151, 0.11276664008296086],
        [-0.7230758855025893, 0.09346528906997387],
        [-0.7224699213891017, 0.09056418593725264],
        [-0.8136095988261282, 0.06578711536551521],
        [-0.8130645356257751, 0.0637821614659351],
        [-0.9031317901081133, 0.0352768876821659],
        [-0.9027463877297923, 0.034059143402646076],
        [-0.9921002448446076, 0.0033641826060818864],
        [-0.9919252198133037, 0.0028546800286948634],
        [-1.0810043138878769, -0.02863337524769121],
        [-1.0810616100493826, -0.02847128552458545],
        [-1.1703327318982564, -0.05941121096094333],
        [-1.1706247201242377, -0.0585687358698628],
        [-1.260544399504162, -0.0875835331943081],
        [-1.2610532802189107, -0.08600646235692966],
        [-1.3520228118307818, -0.11159352224844091],
        [-1.3526998927652092, -0.10918630017097868],
        [-1.4449933082960529, -0.12963946427700396],
        [-1.445737450429139, -0.12628157702068984],
        [-1.4456755509463124, -0.12627247506412628],
        [-1.5392577667680856, -0.13964331155911244],
        [-1.539886603027693, -0.13524209922021316],
        [-1.5397821626863664, -0.13523723635083654],
        [-1.6342212888908998, -0.13944113452338855],
        [-1.6344626300078762, -0.1340194893576483],
        [-1.6343072400059069, -0.1340308570025608],
        [-1.728587773179875, -0.12712965001904541],
        [-1.7281352756190123, -0.1209478746571443],
        [-1.7279363143786957, -0.1209892572698746],
        [-1.8204795313220474, -0.1016957379105527],
        [-1.8191429882025019, -0.09528488058780676],
        [-1.818929044269624, -0.09535994971252389],
        [-1.9079372083943091, -0.06351524814341122],
        [-1.9057866913518704, -0.05750440287136849],
        [-1.9055936197995942, -0.05759970598462228],
        [-1.9895924085028303, -0.014231651444793658],
        [-1.9869277269580736, -0.009070478678008378],
        [-1.9867769956588144, -0.009165463095472401],
        [-2.0649769515964636, 0.04395123194002734],
        [-2.0621472783007384, 0.04811715993866785],
        [-2.062040546436369, 0.048036217542960925],
        [-2.1343258400609804, 0.10895805820056585],
        [-2.1315868579740638, 0.11220792921969751],
        [-2.1315151446002294, 0.11214490391597831],
        [-2.198212487160495, 0.17913824652479565],
        [-2.195697820538466, 0.18164180246905834],
        [-2.195650552392545, 0.18159486693281035],
        [-2.2572917109846937, 0.2532678427545493],
        [-2.255046598754082, 0.2551987144321607],
        [-2.2550153925268908, 0.2551643293999822],
    ])


def test_2(model_2):
    model_2.predict_tangential(strategy='lambda', value=0.03)
    model_2.perform_load_control_step()

    for step in range(1, 120):
        model_2 = model_2.get_duplicate()
        model_2.predict_tangential(strategy='arc-length')
        model_2.perform_arc_length_control_step()

    actual = model_2.load_displacement_curve(('B', 'v'), skip_iterations=False)

    assert_almost_equal(actual.T, [
        [-0.03668411320748388, 0.03],
        [-0.03879392396600667, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
        [-0.03879968834562708, 0.03],
    ])


def test_3(model_3):
    model_3.predict_tangential(strategy='lambda', value=0.03)
    model_3.perform_load_control_step()

    for step in range(1, 120):
        model_3 = model_3.get_duplicate()
        model_3.predict_tangential(strategy='arc-length')
        model_3.perform_arc_length_control_step()

    actual = model_3.load_displacement_curve(('B', 'v'), skip_iterations=False)

    assert_almost_equal(actual.T, [
        [-0.04012369841831065, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
        [-0.04294448569210396, 0.03],
    ])
